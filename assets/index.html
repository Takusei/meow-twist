<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Win Search</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="container rounded">
    <div class="input-wrapper">
      <input id="search" placeholder="Search..." autocomplete="off" />
      <div id="ghost-suggestion" class="ghost"></div>
    </div>
    <div class="right-info">
      <span id="clock">--:-- --</span>
      <span class="icon">üîç</span>
    </div>
  </div>

  <!-- üîΩ Dropdown list below the search bar -->
  <ul id="suggestions" class="suggestions-list"></ul>

  <script>
    const input = document.getElementById('search');
    const ghost = document.getElementById('ghost-suggestion');
    const clock = document.getElementById('clock');
    const suggestionsList = document.getElementById('suggestions');

    let commands = [];

    window.electronAPI.getCommands().then((cmds) => {
      commands = cmds;
    });

    let selectedIndex = -1;
    input.focus();

    const updateClock = () => {
      const now = new Date();
      let hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12;
      clock.textContent = `${hours}:${minutes} ${ampm}`;
    };
    setInterval(updateClock, 1000);
    updateClock();

    input.addEventListener('input', () => {
      const rawText = input.value.trim();

      const hasSpace = rawText.includes(' ');
      const keyword = rawText.split(/\s+/)[0].toLowerCase();

      // üî∏ Determine ghost suggestion (only when single word and match exists)
      if (!keyword || hasSpace) {
        ghost.textContent = '';
      } else {
        const match = commands.find(cmd => cmd.command.startsWith(keyword));
        ghost.textContent = match && keyword !== match.command
          ? rawText + match.command.slice(keyword.length)
          : '';
      }

      // üî∏ Determine matches
      let matches = [];

      if (!rawText) {
        matches = [];
      } else if (!hasSpace) {
        matches = commands.filter(cmd =>
          cmd.command.startsWith(keyword)
        ).slice(0, 2);
      }

      // üî∏ If no matches and user typed something, show fallback Google suggestion
      if (matches.length === 0 && rawText) {
        matches = [{
          command: 'g',
          description: `Search Google for "${rawText}"`,
          icon: 'google.png',
          isFallback: true
        }];
      }

      renderSuggestions(matches);
    });


    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const finalValue = input.value.trim();

        // Reset everything BEFORE triggering actions
        input.value = '';
        ghost.textContent = '';
        renderSuggestions([]);
        selectedIndex = -1;

        if (!finalValue) {
          window.electronAPI.hideWindow();
        } else {
          window.electronAPI.search(finalValue);
        }
      } else if (e.key === 'Escape') {
        window.electronAPI.hideWindow();
        renderSuggestions([]);
      } else if (e.key === 'Tab') {
        e.preventDefault();
        if (ghost.textContent) {
          const words = input.value.split(/\s+/);
          words[0] = ghost.textContent;
          input.value = words.join(' ') + ' ';
          ghost.textContent = '';
        }
      }
    });


    const renderSuggestions = (matches) => {
      const limited = matches.slice(0, 2);
      const container = document.querySelector('.container');
      const baseHeight = 60;
      const itemHeight = 50;

      suggestionsList.innerHTML = '';

      if (limited.length > 0) {
        suggestionsList.innerHTML = limited.map((cmd, idx) => `
          <li class="suggestion-item" data-index="${idx}">
            <div class="suggestion-left">
              <img src="${cmd.icon || 'google.png'}" alt="icon">
              <div class="suggestion-text">
                <div class="suggestion-title">${cmd.command}</div>
                <div class="suggestion-sub">${cmd.description || ''}</div>
              </div>
            </div>
          </li>
        `).join('');

        container.classList.remove('rounded');
        container.classList.add('with-suggestions');

        const totalHeight = baseHeight + limited.length * itemHeight;
        window.electronAPI.resizeWindow(totalHeight);

      } else {
        container.classList.remove('with-suggestions');
        container.classList.add('rounded');

        window.electronAPI.resizeWindow(baseHeight); // üëà always force reset
      }
    };


    window.electronAPI.onReset(() => {
      input.value = '';
      ghost.textContent = '';
      selectedIndex = -1;
      renderSuggestions([]);
    });

    window.addEventListener('blur', () => {
      window.electronAPI.hideWindow();
    });

    input.addEventListener('blur', () => {
      setTimeout(() => {
        if (document.activeElement !== input) {
          window.electronAPI.hideWindow();
        }
      }, 100);
    });
  </script>
</body>
</html>
